{% extends 'sideNavbar.html' %}
{% load static %}

{% block title %}Estad√≠sticas{% endblock %}

{% block content %}
<h1 class="text-primary mb-3">Estad√≠sticas</h1>
<p>Plataforma de adquisici√≥n de par√°metros de voz y variables ambientales.</p>

<form method="POST" class="mb-4">
    {% csrf_token %}
    
    <div class="row g-3">
        <div class="col-md-4">
            <label for="institucion" class="form-label">Instituci√≥n</label>
            <select id="institucion" name="institucion" class="form-select" required>
                <option value="">Seleccione una instituci√≥n</option>
                {% for inst in instituciones %}
                    <option value="{{ inst.id_institucion }}">{{ inst.nombre_institucion }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="profesor" class="form-label">Profesor</label>
            <select id="profesor" name="profesor" class="form-select" required>
                <option value="">Seleccione un profesor</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="fecha_inicio" class="form-label">Fecha y hora inicio</label>
            <input type="datetime-local" id="fecha_inicio" name="fecha_inicio" class="form-control" required>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <div class="col-md-4 offset-md-8">
            <label for="fecha_fin" class="form-label">Fecha y hora fin</label>
            <input type="datetime-local" id="fecha_fin" name="fecha_fin" class="form-control" required>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary w-100">Consultar</button>
    </div>
</form>

{% if resultados_json %}
<hr class="my-4">

<div class="row g-4">
    <div class="col-12">
        <h5 class="mb-2">Frecuencia Fundamental (Hz)</h5>
        <div class="chart-scroll-container">
            <div id="graficoFrecuencia"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Intensidad de la Voz (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoIntensidad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Ruido Ambiental (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoRuido"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Temperatura (¬∞C)</h5>
        <div class="chart-scroll-container">
            <div id="graficoTemperatura"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Humedad Relativa (%)</h5>
        <div class="chart-scroll-container">
            <div id="graficoHumedad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Concentraci√≥n de CO‚ÇÇ (ppm)</h5>
        <div class="chart-scroll-container">
            <div id="graficoCO2"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{% static 'js/EStadisticas/profesores_por_institucion.js' %}"></script>

{% if resultados_json %}
<script>
    const resultados = {{ resultados_json|safe }};
    console.log(resultados);

    const extraerRegistros = (clave) => resultados.flatMap(h => h[clave] || []);

    const crearGraficoPlotly = (divId, titulo, todosLosDatos, campoDatos, campoValor, coloresBase) => {
    const datosPorAula = {};

    todosLosDatos.forEach(horario => {
        const aula = horario.id_aula || 'Desconocido';
        const registros = horario[campoDatos] || [];

        if (!datosPorAula[aula]) datosPorAula[aula] = [];

        registros.forEach(r => {
            if (r[campoValor] !== undefined) {
                datosPorAula[aula].push({
                    x: r.fecha_hora,
                    y: r[campoValor],
                });
            }
        });
    });

    const aulas = Object.keys(datosPorAula);
    const colores = coloresBase || [
        'blue', 'orange', 'green', 'red', 'purple', 'brown', 'teal', 'pink', 'gray', 'black'
    ];

    const data = aulas.map((aula, idx) => ({
        x: datosPorAula[aula].map(p => p.x),
        y: datosPorAula[aula].map(p => p.y),
        name: aula,
        mode: 'lines',
        line: { color: colores[idx % colores.length] },
        connectgaps: false  // <<--- evita conectar puntos lejanos o vac√≠os
    }));


    const hayDatos = data.some(trace => trace.x.length > 0 && trace.y.length > 0);

    const SHAPE_GAP_THRESHOLD_MINUTES = 5;

const parseFecha = str => new Date(str).getTime();

const detectarCortes = () => {
    const shapes = [];

    aulas.forEach((aula, idx) => {
        const puntos = datosPorAula[aula];
        if (puntos.length < 2) return;

        for (let i = 1; i < puntos.length; i++) {
            const t1 = parseFecha(puntos[i - 1].x);
            const t2 = parseFecha(puntos[i].x);
            const deltaMin = (t2 - t1) / (1000 * 60);
            if (deltaMin > SHAPE_GAP_THRESHOLD_MINUTES) {
                shapes.push({
                    type: 'rect',
                    x0: puntos[i].x,
                    x1: puntos[i].x,
                    yref: 'paper',
                    y0: 0,
                    y1: 1,
                    line: {
                        color: 'rgba(150,150,150,0.5)',
                        width: 2,
                        dash: 'dot'
                    }
                });
            }
        }
    });

    return shapes;
};


    const layout = hayDatos ? {
        width: 12000,
        title: titulo,
        xaxis: {
            title: 'Fecha y Hora',
            tickangle: -45,
            tickmode: 'auto',
            nticks: 40
        },
        yaxis: { title: campoValor },
        shapes: detectarCortes(),
        autosize: true,
        height: 400,
        margin: { t: 50, b: 50 },
        legend: { orientation: "h", x: 0, y: -0.2 }
    } : {
        title: titulo,
        xaxis: { visible: false },
        yaxis: { visible: false },
        annotations: [
            {
                text: "Sin datos disponibles",
                xref: "paper",
                yref: "paper",
                showarrow: false,
                font: {
                    size: 20,
                    color: "gray"
                },
                x: 0.5,
                y: 0.5,
                align: "center"
            }
        ],
        autosize: true,
        height: 400,
        margin: { t: 50, b: 50 }
    };

    Plotly.newPlot(divId, data, layout).then(() => {
        // üëá Esto asegura que incluso si lo ignora en la definici√≥n, se aplicar√° igual
        Plotly.updateTraces(divId, { connectgaps: false });
    });
};




crearGraficoPlotly('graficoFrecuencia', 'Frecuencia Fundamental (Hz)', resultados, 'registros_voz', 'freq', ['#1f77b4', '#ff7f0e']);
crearGraficoPlotly('graficoIntensidad', 'Intensidad de Voz (dB)', resultados, 'registros_voz', 'intensidad', ['#2ca02c', '#d62728']);
crearGraficoPlotly('graficoRuido', 'Ruido Ambiental (dB)', resultados, 'registros_ruido', 'ruido');
crearGraficoPlotly('graficoTemperatura', 'Temperatura (¬∞C)', resultados, 'registros_temperatura', 'temperatura');
crearGraficoPlotly('graficoHumedad', 'Humedad Relativa (%)', resultados, 'registros_humedad', 'humedad');
crearGraficoPlotly('graficoCO2', 'CO‚ÇÇ (ppm)', resultados, 'registros_co2', 'co2');


</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .chart-scroll-container {
        overflow-x: auto;
        border: 1px solid #ccc;
        padding: 10px;
        max-width: 100%; /* contenedor no crece m√°s all√° de la pantalla */
    }
    
    .plot-inner {
        min-width: 3000px; /* fuerza que el contenido sea m√°s ancho para activar scroll */
    }
    </style>
{% endblock %}    