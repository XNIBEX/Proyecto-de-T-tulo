{% extends 'sideNavbar.html' %}
{% load static %}

{% block title %}Estadísticas{% endblock %}

{% block content %}
<h1 class="text-primary mb-3">Estadísticas</h1>
<p>Plataforma de adquisición de parámetros de voz y variables ambientales.</p>

<form method="POST" class="mb-4">
    {% csrf_token %}
    
    <div class="row g-3">
        <div class="col-md-4">
            <label for="institucion" class="form-label">Institución</label>
            <select id="institucion" name="institucion" class="form-select" required>
                <option value="">Seleccione una institución</option>
                {% for inst in instituciones %}
                    <option value="{{ inst.id_institucion }}">{{ inst.nombre_institucion }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="profesor" class="form-label">Profesor</label>
            <select id="profesor" name="profesor" class="form-select" required>
                <option value="">Seleccione un profesor</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="fecha_inicio" class="form-label">Fecha y hora inicio</label>
            <input type="datetime-local" id="fecha_inicio" name="fecha_inicio" class="form-control" required>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <div class="col-md-4 offset-md-8">
            <label for="fecha_fin" class="form-label">Fecha y hora fin</label>
            <input type="datetime-local" id="fecha_fin" name="fecha_fin" class="form-control" required>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary w-100">Consultar</button>
    </div>
</form>

{% if resultados_json %}
<hr class="my-4">

<div class="row g-4">
    <div class="col-12">
        <h5 class="mb-2">Frecuencia Fundamental (Hz)</h5>
        <div class="chart-scroll-container">
            <div id="graficoFrecuencia"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Intensidad de la Voz (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoIntensidad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Ruido Ambiental (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoRuido"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Temperatura (°C)</h5>
        <div class="chart-scroll-container">
            <div id="graficoTemperatura"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Humedad Relativa (%)</h5>
        <div class="chart-scroll-container">
            <div id="graficoHumedad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Concentración de CO₂ (ppm)</h5>
        <div class="chart-scroll-container">
            <div id="graficoCO2"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/plotly.js-dist/plotly.min.js"></script>
<script src="{% static 'js/EStadisticas/profesores_por_institucion.js' %}"></script>

{% if resultados_json %}
<script>
    const resultados = {{ resultados_json|safe }};
    const extract = (clave) => resultados.flatMap(h => h[clave]);

    function plotGraph(containerId, title, datos, prop, color) {
        const x = datos.map(r => r.fecha_hora);
        const y = datos.map(r => r[prop]);
        Plotly.newPlot(containerId, [{
            x: x,
            y: y,
            mode: 'lines',
            line: {color: color}
        }], {
            title: title,
            xaxis: { title: 'Tiempo' },
            yaxis: { title: title },
            autosize: false,
            width: 12000,
            height: 400
        }, {responsive: false});
    }

    plotGraph('graficoFrecuencia', 'Frecuencia Fundamental (Hz)', extract('registros_voz'), 'freq', 'blue');
    plotGraph('graficoIntensidad', 'Intensidad de Voz (dB)', extract('registros_voz'), 'intensidad', 'orange');
    plotGraph('graficoRuido', 'Ruido Ambiental (dB)', extract('registros_ruido'), 'valor', 'green');
    plotGraph('graficoTemperatura', 'Temperatura (°C)', extract('registros_temperatura'), 'valor', 'red');
    plotGraph('graficoHumedad', 'Humedad Relativa (%)', extract('registros_humedad'), 'valor', 'purple');
    plotGraph('graficoCO2', 'CO₂ (ppm)', extract('registros_co2'), 'valor', 'brown');
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
.chart-scroll-container {
    overflow-x: auto;
    white-space: nowrap;
    max-width: 100%;
    border: 1px solid #ccc;
}
</style>
{% endblock %}
