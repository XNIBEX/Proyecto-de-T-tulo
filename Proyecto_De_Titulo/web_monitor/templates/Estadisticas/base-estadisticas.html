{% extends 'sideNavbar.html' %}
{% load static %}

{% block title %}Estadísticas{% endblock %}

{% block content %}
<h1 class="text-primary mb-3">Estadísticas</h1>
<p>Plataforma de adquisición de parámetros de voz y variables ambientales.</p>

<form method="POST" class="mb-4">
    {% csrf_token %}
    
    <div class="row g-3">
        <div class="col-md-4">
            <label for="institucion" class="form-label">Institución</label>
            <select id="institucion" name="institucion" class="form-select" required>
                <option value="">Seleccione una institución</option>
                {% for inst in instituciones %}
                    <option value="{{ inst.id_institucion }}">{{ inst.nombre_institucion }}</option>
                {% endfor %}
            </select>
        </div>
        <div class="col-md-4">
            <label for="profesor" class="form-label">Profesor</label>
            <select id="profesor" name="profesor" class="form-select" required>
                <option value="">Seleccione un profesor</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="fecha_inicio" class="form-label">Fecha y hora inicio</label>
            <input type="datetime-local" id="fecha_inicio" name="fecha_inicio" class="form-control" required>
        </div>
    </div>

    <div class="row g-3 mt-3">
        <div class="col-md-4 offset-md-8">
            <label for="fecha_fin" class="form-label">Fecha y hora fin</label>
            <input type="datetime-local" id="fecha_fin" name="fecha_fin" class="form-control" required>
        </div>
    </div>

    <div class="mt-4">
        <button type="submit" class="btn btn-primary w-100">Consultar</button>
    </div>
</form>

{% if resultados_json %}
<hr class="my-4">

<div class="row g-4">
    <div class="col-12">
        <h5 class="mb-2">Frecuencia Fundamental (Hz)</h5>
        <div class="chart-scroll-container">
            <div id="graficoFrecuencia"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Intensidad de la Voz (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoIntensidad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Ruido Ambiental (dB)</h5>
        <div class="chart-scroll-container">
            <div id="graficoRuido"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Temperatura (°C)</h5>
        <div class="chart-scroll-container">
            <div id="graficoTemperatura"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Humedad Relativa (%)</h5>
        <div class="chart-scroll-container">
            <div id="graficoHumedad"></div>
        </div>
    </div>
    <div class="col-12">
        <h5 class="mb-2">Concentración de CO₂ (ppm)</h5>
        <div class="chart-scroll-container">
            <div id="graficoCO2"></div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="{% static 'js/EStadisticas/profesores_por_institucion.js' %}"></script>

{% if resultados_json %}
<script>
    const resultados = {{ resultados_json|safe }};
    console.log(resultados);

    const extraerRegistros = (clave) => resultados.flatMap(h => h[clave] || []);

    const crearGraficoPlotly = (divId, titulo, datos, campo, color) => {
        if (!datos.length) return;

        const x = datos.map(r => r.fecha_hora);
        const y = datos.map(r => r[campo]);

        const data = [{
            x: x,
            y: y,
            mode: 'lines',
            line: { color: color }
        }];

        const layout = {
            title: titulo,
            xaxis: { title: 'Fecha y Hora' },
            yaxis: { title: campo },
            autosize: true,
            height: 400,
            margin: { t: 50, b: 50 },
            width: 20000
        };


        Plotly.newPlot(divId, data, layout);
    };

    // Voz
    crearGraficoPlotly('graficoFrecuencia', 'Frecuencia Fundamental (Hz)', extraerRegistros('registros_voz'), 'freq', 'blue');
    crearGraficoPlotly('graficoIntensidad', 'Intensidad de Voz (dB)', extraerRegistros('registros_voz'), 'intensidad', 'orange');

    // Ambientales
    crearGraficoPlotly('graficoRuido', 'Ruido Ambiental (dB)', extraerRegistros('registros_ruido'), 'ruido', 'green');
    crearGraficoPlotly('graficoTemperatura', 'Temperatura (°C)', extraerRegistros('registros_temperatura'), 'temperatura', 'red');
    crearGraficoPlotly('graficoHumedad', 'Humedad Relativa (%)', extraerRegistros('registros_humedad'), 'humedad', 'purple');
    crearGraficoPlotly('graficoCO2', 'Concentración de CO₂ (ppm)', extraerRegistros('registros_co2'), 'co2', 'brown');
</script>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
    .chart-scroll-container {
        overflow-x: auto;
        border: 1px solid #ccc;
        padding: 10px;
        max-width: 100%; /* contenedor no crece más allá de la pantalla */
    }
    
    .plot-inner {
        min-width: 3000px; /* fuerza que el contenido sea más ancho para activar scroll */
    }
    </style>
{% endblock %}    